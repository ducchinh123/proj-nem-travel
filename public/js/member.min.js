var loginForm=$("#loginForm"),registerForm=$("#registerForm"),apiUrl=Static.rootGate();function getCookie(e){for(var t=e+"=",o=decodeURIComponent(document.cookie).split(";"),n=0;n<o.length;n++){for(var a=o[n];" "===a.charAt(0);)a=a.substring(1);if(0===a.indexOf(t))return a.substring(t.length,a.length)}return""}function getCookieDomain(){return"localhost"===document.location.hostname?document.location.hostname:".ivivu.com"}function logoutUser(){var e=getCookie("auth_token");$.ajax({type:"GET",url:apiUrl+"api/Account/Logout",contentType:"application/json; charset=utf-8",beforeSend:function(t){t.setRequestHeader("Authorization","Bearer "+e)},success:function(e){createCookie("auth_token","",-1,getCookieDomain()),watchToken(),getUserHeader(),checkBizAccount(e)},error:function(e){createCookie("auth_token","",-1,getCookieDomain()),watchToken(),getUserHeader(),checkBizAccount(e)}})}loginForm.submit(function(e){e.preventDefault();var t=loginForm.find('input[name="EmailPhoneDN"]').val(),o=loginForm.find('input[name="PasswordDN"]').val(),n=loginForm.find('input[name="IsRedirectMember"]').val();$.ajax({type:"POST",url:apiUrl+"api/Account/Login",data:JSON.stringify({EmailOrPhone:t,Password:o}),processData:!1,contentType:"application/json; charset=utf-8",success:function(e){createCookie("auth_token",e.auth_token,30,getCookieDomain()),watchToken(),"true"===n?window.location.href="https://member.ivivu.com/dashboard/rewards":(getUserHeader(),$("#LoginModal").modal("hide"))},error:function(e){void 0===e.responseJSON&&loginForm.find(".errorMsg").text("Kh\xf4ng thể kết nối đến m\xe1y chủ !"),void 0!==e.responseJSON.msg&&loginForm.find(".errorMsg").text(e.responseJSON.msg)}})}),registerForm.submit(function(e){if(e.preventDefault(),registerForm.find('input[name="policy-checkbox"]').prop("checked")){var t=registerForm.find('input[name="EmailDK"]').val(),o=registerForm.find('input[name="PasswordDK"]').val(),n=registerForm.find('input[name="RePasswordDK"]').val();$.ajax({type:"POST",url:apiUrl+"api/Account/Register",data:JSON.stringify({Email:t,Password:o,Password2:n}),processData:!1,contentType:"application/json; charset=utf-8",success:function(e){createCookie("auth_token",e.auth_token,30,getCookieDomain()),watchToken(),getUserHeader(),$("#RegisterModal").modal("hide"),$("#LoginModal").modal("show")},error:function(e){void 0===e.responseJSON&&loginForm.find(".errorMsg").text("Kh\xf4ng thể kết nối đến m\xe1y chủ !"),void 0!==e.responseJSON.msg&&registerForm.find(".errorMsg").text(e.responseJSON.msg)}})}else registerForm.find(".errorMsg").text("Bạn phải đồng \xfd với điều khoản của iVIVU !")});var showRegisterDialog=function(){registerForm.find(".errorMsg").text(""),registerForm.find('input[name="EmailDK"]').val(""),registerForm.find('input[name="PasswordDK"]').val(""),registerForm.find('input[name="RePasswordDK"]').val(""),registerForm.find('input[name="policy-checkbox"]').prop("checked",!1),$("#RegisterModal").modal()},showLoginDialog=function(){loginForm.find(".errorMsg").text(""),loginForm.find('input[name="EmailPhoneDN"]').val(""),loginForm.find('input[name="PasswordDN"]').val(""),$("#LoginModal").modal()};function getUserHeader(){var e;setTimeout(function(){if(""!==$("#hdhdhdhhdhdhdhdhdhd").val());else{var t=getCookie("auth_token"),o=1;null!==t&&""!==t?$.ajax({type:"GET",url:apiUrl+"api/Dashboard/Getuserinfo",contentType:"application/json; charset=utf-8",beforeSend:function(e){e.setRequestHeader("Authorization","Bearer "+t)},success:function(t){e=$("#UserLogged").html(),checkBizAccount(t),$("#UserLogin .user-menu-list").html(e),$("#UserLogin .username-header").html(getShortName(t.fullname));var o=t.avatar;$("#UserLogin img.img-circle").attr("src",o),$("#UserLogin .userMail-header").text(t.email),$("#UserLogin .userPoint-header").text(numberStr(t.point))},error:function(n,a,i){if(e=$("#UserNotLogged").html(),$("#UserLogin .user-menu-list").html(e),$("#UserLogin .username-header").html("T\xe0i khoản"),$("#UserLogin img.img-circle").attr("src",$("#UserLogin img.img-circle").data("src")),401==n.status){var r=this;refreshToken(function(e){e&&e.auth_token&&(createCookie("auth_token","",-1,getCookieDomain()),createCookie("auth_token",t=e.auth_token,60,getCookieDomain()),location.reload(),o>0&&(o--,$.ajax(r)))})}}}):(e=$("#UserNotLogged").html(),$("#UserLogin .user-menu-list").html(e),$("#UserLogin .username-header").html("T\xe0i khoản"),$("#UserLogin img.img-circle").attr("src",$("#UserLogin img.img-circle").data("src")))}},1e3)}function create_UUID(){var e=new Date().getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var o=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?o:3&o|8).toString(16)})}function tokenChange(e){e.$apply(function(){e.tockenChange=document.getElementById("token_change").value})}function watchToken(){document.getElementById("token_change").value=create_UUID();try{setTimeout(function(){$("#tokenclick").trigger("click");var e=angular.element(".htdt-container").scope();e?tokenChange(e):(e=angular.element(".main-home").scope())?tokenChange(e):(e=angular.element(".list-content").scope())&&tokenChange(e)},200)}catch(e){console.log(e)}}function numberStr(e){if(void 0===e)return"undefined";var t=e.toString().split(".");return t[0]=t[0].replace(/\B(?=(\d{3})+(?!\d))/g,","),t.join(".")}function checkAvatarURL(e){return null===e?e:e.startsWith("http://")||e.startsWith("https://")?e:this.avatarFolderUrl+"/"+e}function getShortName(e){if(null!==e)return e.match(/[a-z0-9._%+-]+@Html.Raw("@[a-z0-9.-]")+\.[a-z]{2,3}$/g)?e.split("@Html.Raw('@')")[0]:e.split(" ").pop().replace(/[&\/\\#,+()$~%.'":*?<>{}]/g,"")}getUserHeader(),watchToken(),window.fbAsyncInit=function(){FB.init({appId:"628025334278848",autoLogAppEvents:!0,xfbml:!0,version:"v10.0",status:!1,cookie:!1})};var socialUser={userData:{email:"",name:"",id:"",image:"",provider:"",token:"",idToken:""}};function loginByFacebook(){window.fbAsyncInit(),socialUser.userData.provider="facebook",FB.login(function(e){FB.getLoginStatus(function(e){"connected"===e.status?(socialUser.userData.token=e.authResponse.accessToken,FB.api("/me","GET",{fields:"id, name, email"},function(e){socialUser.userData.name=e.name,socialUser.userData.id=e.id,socialUser.userData.image="https://graph.facebook.com/"+e.id+"/picture?type=large",socialUser.userData.email=e.email,""===socialUser.userData.email||null===socialUser.userData.email||void 0===socialUser.userData.email?$.ajax({type:"POST",url:apiUrl+"api/account/CheckSocialNoEmail",data:JSON.stringify(socialUser),processData:!1,contentType:"application/json; charset=utf-8",success:function(e){e.result?checkValidUser(socialUser,function(e){loginSocial(socialUser)}):($(".close-modal-button").click(),$("#GetSocialModal").modal())},error:function(e){void 0!==e.responseJSON.msg&&loginForm.find(".errorMsg").text(e.responseJSON.msg)}}):checkValidUser(socialUser,function(e){loginSocial(socialUser)})})):loginForm.find(".errorMsg").text("Login t\xe0i khoản Facebook kh\xf4ng th\xe0nh c\xf4ng !")})})}$(function(){setTimeout(function(){window.fbAsyncInit()},1e3)});var googleUser={},startApp=function(){gapi.load("auth2",function(){auth2=gapi.auth2.init({client_id:"375816142694-o1h018pafnfnb7uacd1uvekddg29m10i.apps.googleusercontent.com"}),attachSignin(document.getElementById("loginGoogleButton")),attachSignin(document.getElementById("registerGoogleButton"))})};function attachSignin(e){auth2.attachClickHandler(e,{},function(e){var t=e.getBasicProfile();socialUser.userData.provider="google",socialUser.userData.id=t.Eea,socialUser.userData.email=t.getEmail(),socialUser.userData.name=t.getName(),socialUser.userData.image=t.getImageUrl(),socialUser.userData.idToken=e.getAuthResponse().id_token,loginSocial(socialUser)},function(e){loginForm.find(".errorMsg").text("Login t\xe0i khoản Google kh\xf4ng th\xe0nh c\xf4ng !")})}function getSocialEmail(){void 0!==document.getElementById("socialEmail")&&(socialUser.userData.email=document.getElementById("socialEmail").value,loginSocial(socialUser))}function loginSocial(e){var t=loginForm.find('input[name="IsRedirectMember"]').val();$.ajax({type:"POST",url:apiUrl+"api/account/socialLogin",data:JSON.stringify(e),processData:!1,contentType:"application/json; charset=utf-8",success:function(e){createCookie("auth_token","",-1,getCookieDomain()),createCookie("auth_token",e.auth_token,30,getCookieDomain()),"true"===t?window.location.href="https://member.ivivu.com/dashboard/rewards":(watchToken(),getUserHeader(),$("#LoginModal").modal("hide"),$("#RegisterModal").modal("hide"),$("#GetSocialModal").modal("hide"))},error:function(e){void 0!==e.responseJSON.msg&&($("#GetSocialModal").find(".errorMsg").empty().text(e.responseJSON.msg),loginForm.find(".errorMsg").text(e.responseJSON.msg),registerForm.find(".errorMsg").text(e.responseJSON.msg))}})}function checkValidUser(e,t){$.ajax({type:"POST",url:apiUrl+"api/account/checkValidUser",data:JSON.stringify(e),processData:!1,contentType:"application/json; charset=utf-8",success:function(e){void 0!==t&&(e.result?($(".close-modal-button").click(),$("#GetValidUser").modal()):t(e))},error:function(e){void 0!==e.responseJSON.msg&&$("#GetValidUser").find(".errorMsg").empty().text(e.responseJSON.msg)}})}function refreshToken(e){var t=getCookie("auth_token");t&&$.ajax({type:"POST",url:apiUrl+"api/account/refreshtoken",data:JSON.stringify({currentTokenId:t}),processData:!1,contentType:"application/json; charset=utf-8",success:function(t){e(t)},error:function(e,t,o){logoutUser()}})}function mapPhoneOrEmail(){if(void 0!==document.getElementById("emailOrPhone")){var e=document.getElementById("emailOrPhone").value;GetSocialModal,$.ajax({type:"POST",url:apiUrl+"api/account/MapUserByEmailOrPhone",data:JSON.stringify({userData:socialUser.userData,EmailOrPhone:e}),processData:!1,contentType:"application/json; charset=utf-8",success:function(e){loginSocial(socialUser),$(".close-modal-button").click()},error:function(e){}})}}function fillInfoToForm(e){try{var t=getCookie("auth_token");t&&$.ajax({type:"GET",url:apiUrl+"api/Dashboard/Getuserinfo",contentType:"application/json; charset=utf-8",beforeSend:function(e){e.setRequestHeader("Authorization","Bearer "+t)},success:function(t){if(t)for(var o=0;o<e.length;o++)"input"===e[o].type&&("name"===e[o].mapto&&$(e[o].element).val(t.fullname),"email"===e[o].mapto&&$(e[o].element).val(t.email),"phone"===e[o].mapto&&$(e[o].element).val(t.phone))},error:function(e){}})}catch(o){return}}function checkBizAccount(e){var t=e.bizAccount;if(t){var o=t.policy.bizPolicy;window.localStorage.setItem("biz_policy",JSON.stringify(t)),window.localStorage.setItem("isShowBizAcc",!0);var n=window.localStorage.getItem("isBizTrip");(void 0==n||null==n)&&(window.localStorage.setItem("isBizTrip",!0),o.hotel_bugget&&o.hotel_bugget>0?window.localStorage.setItem("isBizAcc_hotel_bugget",o.hotel_bugget):window.localStorage.removeItem("isBizAcc_hotel_bugget"))}else window.localStorage.removeItem("isBizTrip"),window.localStorage.removeItem("biz_policy"),window.localStorage.removeItem("isBizAcc_hotel_bugget"),window.localStorage.removeItem("isShowBizAcc")}function afterUserLogged(e,t){try{var o=getCookie("auth_token");if(null===o||""===o)return t&&t(),!1;$.ajax({type:"GET",async:!0,url:apiUrl+"api/Dashboard/Getuserinfo",contentType:"application/json; charset=utf-8",beforeSend:function(e){e.setRequestHeader("Authorization","Bearer "+o)},success:function(o){o&&e?(checkBizAccount(o),e(o)):t&&t()},error:function(e){return t&&t(),!1}})}catch(n){return t&&t(),!1}}startApp();